
<!doctype html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> 	
<html lang="en"> 
<!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />	<!-- Force Latest IE rendering engine -->
    <title>Stop relying on your ORM and learn SQL</title>

    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->


    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href="http://feeds.feedburner.com/sirupsen" rel="alternate" title="Sirupsen" type="application/atom+xml" /> 
    <link rel="shortcut icon" href="/static/images/favicon.png" />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 

    <link rel="stylesheet" href="/static/css/style.css">

    <!--[if IE 7]>
      <script src="/static/css/font-awesome-ie7.css"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">	
      <div id='mobile' class='two columns hidden'>
        <ul>
          <li><a href='/'>Sirupsen</a></li>
          <li><span class="gray">Simon Hørup Eskildsen</span></li>
          <li><a href="mailto:sirup@sirupsen.com" onClick="_gaq.push(['_trackEvent', 'Link', 'Click', 'Mobile', 'Sidebar Email']);">sirup@sirupsen.com</a></li>
          <li><a href="http://twitter.com/Sirupsen" onClick="_gaq.push(['_trackEvent', 'Link', 'Click', 'Mobile', Sidebar Email']);">@Sirupsen</a></li>
        </ul>
      </div>

      <div class="four columns sidebar">
        <section>
          <a id="avatar" href="/"></a>

          <ul id="social">
            <li>
              <a href="mailto:sirup@sirupsen.com?subject=hi" class="icon-envelope-alt" onClick="_gaq.push(['_trackEvent', 'Link', 'Click', 'Sidebar Email']);" title="Say hi"></a>
            </li>

            <li>
              <a href="http://twitter.com/Sirupsen" class="icon-twitter" onClick="_gaq.push(['_trackEvent', 'Link', 'Click', 'Sidebar Twitter']);" title="You should follow me" style="font-size: 28px;"></a>
            </li>

            <li>
              <a href="http://github.com/Sirupsen" class="icon-github" onClick="_gaq.push(['_trackEvent', 'Link', 'Click', 'Sidebar Github']);" title="I share and fork code here"></a>
            </li>

            <li>
              <a href="skype:sirupsen?add" class="icon-comment" onClick="_gaq.push(['_trackEvent', 'Link', 'Click', 'Sidebar Skype']);" title="Feel free to add me on Skype"></a>
            </li>

            <li>
              <a href="http://feeds.feedburner.com/sirupsen" class="icon-rss" onClick="_gaq.push(['_trackEvent', 'Link', 'Click', 'Sidebar RSS']);" title="RSS"></a>
            </li>
          </ul>

          <ul id="me">
            <li>Simon Hørup Eskildsen</span></li>
            <li class="gray">Ruby developer.</li>
          </ul>

        </section>
      </div>

      <article class='ten columns offset-by-four' id="article-content">
  <header class="ten columns" id="article-header">
    <h1>Stop relying on your ORM and learn SQL</h1>
  </header>

  <div class='ten columns gray' id="date-header">
    <p>
      Mar 2011
  
    </p>

  </div>

  <div class="ten columns" id="article-content">
    <p>In modern development, and in particular with web frameworks such as Rails that offer and encourage extensive use of database ORM libraries, some developers skip learning SQL in favour of using ORMs. It is as if developers think they no longer need to know SQL when they’ve got an ORM. The truth is that we are not this fortunate. You should <em>only</em> use an ORM if you know exactly what it is generated by the ORM and you are sure that the generated SQL is as well performing as what you could have written by hand.</p>

<p>Let me go through the most common pitfall I see.</p>

<p>You have a blog listing a bunch of posts: title, content, author, date and the number of associated comments. </p>

<p>Typically one would do it like this in Rails:</p>

<div class="highlight"><pre><code class="erb"><span class="cp">&lt;%</span> <span class="k">for</span> <span class="n">post</span> <span class="k">in</span> <span class="vi">@posts</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">title</span> <span class="cp">%&gt;</span><span class="x">&lt;/h1&gt;</span>
<span class="x">  &lt;p&gt;</span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
<span class="x">  &lt;p&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span> <span class="cp">%&gt;</span><span class="x"> posted on </span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">created_at</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span><span class="x"> comments</span>
<span class="x">  &lt;/p&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</code></pre>
</div>

<p>This looks simple enough, and it is – the issue here is the query for retrieving the number of comments associated (<code>post.comments.count</code>) is run for each blog post, although it could easily be included in the main SQL query fetching the posts with a join:</p>

<div class="highlight"><pre><code class="sql"><span class="k">SELECT</span> <span class="n">posts</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="n">comments</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">as</span> <span class="n">comments_count</span> <span class="k">FROM</span> <span class="ss">&quot;users&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;comments&quot;</span> <span class="k">ON</span> <span class="n">comments</span><span class="p">.</span><span class="n">post_id</span> <span class="o">=</span> <span class="n">posts</span><span class="p">.</span><span class="n">id</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">posts</span><span class="p">.</span><span class="n">id</span>
</code></pre>
</div>

<p>Or in Rails’ ORM:</p>

<div class="highlight"><pre><code class="ruby"><span class="no">Post</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">:joins</span> <span class="o">=&gt;</span> <span class="ss">:comments</span><span class="p">,</span> <span class="ss">:select</span> <span class="o">=&gt;</span> <span class="s2">&quot;posts.*, count(comments.id) as comments_count&quot;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="s2">&quot;posts.id&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>For a typical blog an extra 20 count queries are not critical, but once your database reaches a certain size a noticeable, avoidable, delay will occur on that page. Something that could have been avoided with a basic understanding of SQL.</p>

<p>ORMs are indeed very useful to developers, however you should not neglect learning SQL because you have it.</p>

<p>Every time you use your ORM you should stop for a moment and think to yourself: “Can I be sure the ORM is generating the optimum query possible here?”</p>

  </div>

  <footer class="ten columns">
    <p id='follow'>
      You should follow me on Twitter <a href="http://twitter.com/Sirupsen" onClick="_gaq.push(['_trackEvent', 'Link', 'Click', 'Post Twitter']);">here.</a>
    </p>
  </footer>
</article>

    </div>

    <script> var _gaq=[["_setAccount","UA-9939782-5"],["_trackPageview"]]; (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1; g.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js"; s.parentNode.insertBefore(g,s)}(document,"script")); </script>
  </body>
</html> 
