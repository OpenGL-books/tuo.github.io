
<!doctype html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> 	
<html lang="en"> 
<!--<![endif]-->
  <head>
    <meta charset="utf-8" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />	<!-- Force Latest IE rendering engine -->
    <title>iOS解决CSV文件的中文编码问题</title>

    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->


    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href="http://feeds2.feedburner.com/tu0huang" rel="alternate" title="Tuo" type="application/atom+xml" /> 
    <link rel="shortcut icon" href="/static/images/favicon.png" />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 

    <link rel="stylesheet" href="/static/css/style.css">

    <!--[if IE 7]>
      <script src="/static/css/font-awesome-ie7.css"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">	
      <div id='mobile' class='two columns hidden'>
        <ul>
          <li><a href='/'>tuohuang</a></li>
          <li><span class="gray">Tuo Huang 黄拓</span></li>
          <li><a href="mailto:clarkhtse@gmail.com.com">clarkhtse@gmail.com.com</a></li>
          <li><a href="http://twitter.com/tu0huang">@tu0huang</a></li>
        </ul>
      </div>

      <div class="four columns sidebar">
        <section>
          <a id="avatar" href="/"></a>

          <ul id="social">
            <li>
              <a href="mailto:clarkhtse@gmail.com?subject=hi" class="icon-envelope-alt" title="Say hi"></a>
            </li>

            <li>
              <a href="http://twitter.com/tu0huang" class="icon-twitter" title="You should follow me" style="font-size: 28px;"></a>
            </li>

            <li>
              <a href="http://github.com/tuo" class="icon-github"  title="I share and fork code here"></a>
            </li>
            <li>
              <a href="http://feeds2.feedburner.com/tu0huang" class="icon-rss" onClick="_gaq.push(['_trackEvent', 'Link', 'Click', 'Sidebar RSS']);" title="RSS"></a>
            </li>
          </ul>

          <ul id="me">
            <li>Tuo Huang 黄拓</span><a href="http://weibo.com/tu0huang" style="display:inline-block;"><img src='/static/images/sinaweibo.png'/></a></li>
            <li class="gray">iOS and Android developer.</li>
          </ul>

        </section>
      </div>

      <article class='ten columns offset-by-four' id="article-content">
  <header class="ten columns" id="article-header">
    <h1>iOS解决CSV文件的中文编码问题</h1>
  </header>

  <div class='ten columns gray' id="date-header">
    <p>
      Jan 18, 2013
  
    </p>

  </div>

  <div class="ten columns" id="article-content">
    <h2 id="section">起因</h2>

<p>    最近一次iOS项目中需要按照CSV格式拼装字符串然后添加到邮件作为附件。但是在这个过程我遇到两个很常见的问题：CSV格式和non-ascii编码及BOM(Byte Order Mark)字节顺序标记。</p>

<h2 id="csv">CSV格式</h2>
<p>这个比较棘手过程开始于：因为将要发送的CSV字符串中有中文符号（数据统计相关的东西），所以我需要支持unicode编码。
<br />
当然最简单的实现方式是:</p>

<div class="highlight"><pre><code class="objectivec">	
<span class="n">MFMailComposeViewController</span> <span class="o">*</span><span class="n">emailComposer</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MFMailComposeViewController</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>	 
<span class="n">NSMutableString</span> <span class="o">*</span><span class="n">csvString</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableString</span> <span class="n">string</span><span class="p">];</span>
<span class="p">[</span><span class="n">csvString</span> <span class="n">appendString</span><span class="o">:</span><span class="s">@&quot;姓名,性别,体重,创建时间</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">];</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">timestamp</span> <span class="o">=</span> <span class="p">[</span><span class="n">dateFormatter</span> <span class="n">stringFromDate</span><span class="o">:</span><span class="p">[</span><span class="n">NSDate</span> <span class="n">date</span><span class="p">]];</span>
<span class="p">[</span><span class="n">csvString</span> <span class="n">appendString</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;%@,%@,%@,%@</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">@&quot;黄拓&quot;</span><span class="p">,</span> <span class="s">@&quot;男&quot;</span><span class="p">,</span> <span class="s">@&quot;65 kg&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">]];</span>
<span class="p">[</span><span class="n">csvString</span> <span class="n">appendString</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;%@,%@,%@,%@</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">@&quot;詹姆斯&quot;</span><span class="p">,</span> <span class="s">@&quot;女&quot;</span><span class="p">,</span> <span class="s">@&quot;25 kg&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">]];</span>	
<span class="p">[</span><span class="n">picker</span> <span class="n">addAttachmentData</span><span class="o">:</span><span class="p">[</span><span class="n">csvString</span> <span class="n">dataUsingEncoding</span><span class="o">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]</span>  <span class="n">mimeType</span><span class="o">:</span><span class="s">@&quot;text/csv&quot;</span> <span class="n">fileName</span><span class="o">:</span><span class="s">@&quot;statistics.csv&quot;</span><span class="p">];</span>
</code></pre>
</div>

<p><br />
我们创建了一个<em>MFMailComposeViewController</em>实例，然后以逗号作为分隔符，’\n’作为换行标记来拼接我们的CSV字符串。在最后，我们设置数据的编码为<em>NSUTF8StringEncoding</em>.没什么特别的。
<br />
**然后你迫不及待的从邮箱中下载打开CSV文件，但是发现却是一坨乱码！ **
<br />
分隔符貌似没有效果，所有的数据都挤在了一个格子里，而且只有一行。</p>

<h5 id="section-1">修复</h5>

<p>很简单的一个修复办法是将逗号替换为tab(‘\t’)，并且将换行符替换为’\r\n’.如果你不这么做，它就没办法工作。 @_@
<br />
下面是一个修复的版本：</p>

<div class="highlight"><pre><code class="objectivec">		
<span class="n">MFMailComposeViewController</span> <span class="o">*</span><span class="n">emailComposer</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MFMailComposeViewController</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>	 
 <span class="n">NSMutableString</span> <span class="o">*</span><span class="n">csvString</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableString</span> <span class="n">string</span><span class="p">];</span>
<span class="p">[</span><span class="n">csvString</span> <span class="n">appendString</span><span class="o">:</span><span class="s">@&quot;姓名</span><span class="se">\t</span><span class="s">性别</span><span class="se">\t</span><span class="s">体重</span><span class="se">\t</span><span class="s">创建时间</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">];</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">timestamp</span> <span class="o">=</span> <span class="p">[</span><span class="n">dateFormatter</span> <span class="n">stringFromDate</span><span class="o">:</span><span class="p">[</span><span class="n">NSDate</span> <span class="n">date</span><span class="p">]];</span>
<span class="p">[</span><span class="n">csvString</span> <span class="n">appendString</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;%@</span><span class="se">\t</span><span class="s">%@</span><span class="se">\t</span><span class="s">%@</span><span class="se">\t</span><span class="s">%@</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">@&quot;黄拓&quot;</span><span class="p">,</span> <span class="s">@&quot;男&quot;</span><span class="p">,</span> <span class="s">@&quot;65 kg&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">]];</span>
<span class="p">[</span><span class="n">csvString</span> <span class="n">appendString</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;%@</span><span class="se">\t</span><span class="s">%@</span><span class="se">\t</span><span class="s">%@</span><span class="se">\t</span><span class="s">%@</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">@&quot;詹姆斯&quot;</span><span class="p">,</span> <span class="s">@&quot;女&quot;</span><span class="p">,</span> <span class="s">@&quot;25 kg&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">]];</span>	
<span class="p">[</span><span class="n">picker</span> <span class="n">addAttachmentData</span><span class="o">:</span><span class="p">[</span><span class="n">csvString</span> <span class="n">dataUsingEncoding</span><span class="o">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]</span>  <span class="n">mimeType</span><span class="o">:</span><span class="s">@&quot;text/csv&quot;</span> <span class="n">fileName</span><span class="o">:</span><span class="s">@&quot;statistics.csv&quot;</span><span class="p">];</span>
</code></pre>
</div>

<p>现在你重新试一下，会发现格式已经正确了，有正确的格子数和行数。	
<br />
<strong>新的问题是： 每个格子的中文都是乱码？</strong>
<img src="/static/images/20130118/1.png" alt="乱码" /></p>

<h2 id="non-asciibom">Non-ASCII编码以及BOM</h2>

<p>要解决这些乱码问题，首先我们需要指导为什么我们可以通过向CSV文件的头部插入BOM的方式来消除乱码？长话短说，就是它一个让文件接收方知道发送方使用了何种Unicode编码方式的标记，所以通过它我们可以正确的解析字符流。
<br />
通过<a href="http://en.wikipedia.org/wiki/Byte_order_mark">BOM Wiki</a>，我们指导utf-8的十六位表示是”EF BB BF”. 接着我们可以将其添加到CSV字符串的头部，
然后特别需要的是将编码格式从utf-8改为utf-16，否则中文将无法正常显示。</p>

<p>下面是最终代码：</p>

<div class="highlight"><pre><code class="objectivec">	
<span class="n">NSMutableString</span> <span class="o">*</span><span class="n">csvString</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableString</span> <span class="n">string</span><span class="p">];</span>
<span class="p">[</span><span class="n">csvString</span> <span class="n">appendString</span><span class="o">:</span><span class="s">@&quot;姓名</span><span class="se">\t</span><span class="s">性别</span><span class="se">\t</span><span class="s">体重</span><span class="se">\t</span><span class="s">创建时间</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">];</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">timestamp</span> <span class="o">=</span> <span class="p">[</span><span class="n">dateFormatter</span> <span class="n">stringFromDate</span><span class="o">:</span><span class="p">[</span><span class="n">NSDate</span> <span class="n">date</span><span class="p">]];</span>
<span class="p">[</span><span class="n">csvString</span> <span class="n">appendString</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;</span><span class="se">\xEF\xBB\xBF</span><span class="s">%@</span><span class="se">\t</span><span class="s">%@</span><span class="se">\t</span><span class="s">%@</span><span class="se">\t</span><span class="s">%@</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">@&quot;黄拓&quot;</span><span class="p">,</span> <span class="s">@&quot;男&quot;</span><span class="p">,</span> <span class="s">@&quot;65 kg&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">]];</span>
<span class="p">[</span><span class="n">csvString</span> <span class="n">appendString</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;</span><span class="se">\xEF\xBB\xBF</span><span class="s">%@</span><span class="se">\t</span><span class="s">%@</span><span class="se">\t</span><span class="s">%@</span><span class="se">\t</span><span class="s">%@</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">@&quot;詹姆斯&quot;</span><span class="p">,</span> <span class="s">@&quot;女&quot;</span><span class="p">,</span> <span class="s">@&quot;25 kg&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">]];</span>
 <span class="n">NSString</span> <span class="o">*</span><span class="n">sourceString</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithFormat</span><span class="o">:</span><span class="s">@&quot;</span><span class="se">\xEF\xBB\xBF</span><span class="s">%@&quot;</span><span class="p">,</span> <span class="n">csvString</span><span class="p">];</span>
<span class="n">NSData</span> <span class="o">*</span><span class="n">encodedData</span> <span class="o">=</span> <span class="p">[</span><span class="n">sourceString</span> <span class="n">dataUsingEncoding</span><span class="o">:</span><span class="n">NSUTF16StringEncoding</span> <span class="n">allowLossyConversion</span><span class="o">:</span><span class="nb">YES</span><span class="p">];</span>
<span class="p">[</span><span class="n">picker</span> <span class="n">addAttachmentData</span><span class="o">:</span><span class="n">encodedData</span> <span class="n">mimeType</span><span class="o">:</span><span class="s">@&quot;text/csv&quot;</span> <span class="n">fileName</span><span class="o">:</span><span class="s">@&quot;statistics.csv&quot;</span><span class="p">];</span>
</code></pre>
</div>

<p>你可以很奇怪，我们应该只需要在头部添加BOM标记就好啦， 为什么每一行内容都需要添加这个标记？
具体原因我无法解释，但是如果不加了，那么显示一行可能没问题，但是如果一旦显示超过四五行的内容，就会出现奇怪的乱码。 <br />
<img src="/static/images/20130118/2.png" alt="乱码" />  </p>

<p><br />
Okay 搞定!</p>

  </div>
  <hr style="visibility:hidden;"/>
  
  <!--<footer class="ten columns">
    <p id='follow'>
       Follow me on <a href="http://twitter.com/tu0huang">Twitter</a> &
       <a href="http://weibo.com/tu0huang">Weibo</a>	   
    </p>
  </footer> -->
</article>

<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ten columns offset-by-four" style="margin-bottom: 11px;">
	<a class="addthis_counter addthis_pill_style"></a>
</div>
<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50f9651243f1723a"></script>
<!-- AddThis Button END -->
<div style="margin-bottom:10px;"/>
<div id="disqus_thread" class="ten columns offset-by-four"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'tuohuang'; // required: replace example with your forum shortname
  var disqus_identifier = '/tuohuangid';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>
  </body>
</html> 
